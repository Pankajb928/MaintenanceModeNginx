worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    # Include the shared maintenance dictionary definition
    include /etc/nginx/common/maintenance.conf;

    resolver 127.0.0.11 ipv6=off;

    server {
        listen       80;
        server_name  localhost;

        # Root now redirects to learner or admin, or just shows a landing page
        location = / {
            return 302 /learner/;
        }

        # --- LEARNER APP ---
        location /learner/ {
            # 1. Set the Scope
            set $maintenance_scope "LEARNER";

            # 2. Check Maintenance
            access_by_lua_file /etc/nginx/lua/maintenance.lua;

            # 3. Proxy to Learner Backend
            proxy_pass http://learner/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # --- ADMIN PORTAL APP ---
        location /admin/ {
            # 1. Set the Scope
            set $maintenance_scope "ADMIN_PORTAL";

            # 2. Check Maintenance
            access_by_lua_file /etc/nginx/lua/maintenance.lua;

            # 3. Proxy to Admin Portal Backend
            proxy_pass http://admin_portal/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Error page for 503 (Maintenance)
        error_page 503 @maintenance;
        location @maintenance {
            default_type application/json;
            return 503 '{"error": "maintenance_mode", "message": "This application is currently under maintenance."}';
        }
    }
}
