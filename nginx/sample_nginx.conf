worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile on;
    keepalive_timeout 65;

    # Lua shared cache
    include /etc/nginx/common/maintenance.conf;

    # DNS resolver (needed for AWS)
    resolver 169.254.169.253 ipv6=off;

    server {
        listen 80;
        server_name example.com;

        # Run maintenance check BEFORE proxying
        access_by_lua_file /etc/nginx/lua/maintenance.lua;

        location / {
            proxy_pass http://backend_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Maintenance page
        error_page 503 /maintenance.html;
        location = /maintenance.html {
            root /var/www/maintenance;
            internal;
        }
    }
}
